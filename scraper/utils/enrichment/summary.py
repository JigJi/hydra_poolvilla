import os
import json
import random
from pathlib import Path
from dotenv import load_dotenv
import openai

# --- 1. Setup Environment ---
load_dotenv() # ‡πÇ‡∏´‡∏•‡∏î .env ‡∏à‡∏≤‡∏Å Directory ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
client = openai.OpenAI(api_key=OPENAI_API_KEY)

# --- 2. Helper Functions ---
def is_clean_name(name):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å"""
    if not name: return False
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô: ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡πÅ‡∏õ‡∏•‡∏Å‡πÜ ‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á
    return True 

# --- 3. Core Engine 1: Short Description (Rule-based Shuffler) ---
def generate_short_desc(row):
    try:
        # 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
        nearby = json.loads(row['nearbyPlaces']) if isinstance(row['nearbyPlaces'], str) else row.get('nearbyPlaces', [])
        
        # 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏≠‡∏≤ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å)
        clean_nearby = []
        for p in nearby:
            if is_clean_name(p.get('name')):
                dist = str(p.get('distance', '')).replace('*', '').strip()
                clean_nearby.append({'name': p['name'], 'distance': dist})
        
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
        top_nearby = clean_nearby[:5]

        # 3. ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ö‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢)
        loc_verbs = [
            "‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏Å‡∏•‡∏à‡∏≤‡∏Å", "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏∞‡πÅ‡∏ß‡∏Å", "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ö", "‡∏ó‡∏≥‡πÄ‡∏•‡∏î‡∏µ‡πÉ‡∏Å‡∏•‡πâ", 
            "‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÑ‡∏õ", "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì", "‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ö",
            "‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏Å‡∏•‡∏ô‡∏±‡∏Å‡∏à‡∏≤‡∏Å", "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î", "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏¢‡πà‡∏≤‡∏ô", "‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏≤‡∏Å",
            "‡πÉ‡∏ô‡∏ó‡∏≥‡πÄ‡∏•‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ö", "‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà", "‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏≤‡∏Å", 
            "‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏à‡∏Å‡∏•‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ", "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏à‡∏≤‡∏Å", "‡πÑ‡∏°‡πà‡πÑ‡∏Å‡∏•‡∏à‡∏≤‡∏Å"
        ]

        if not top_nearby:
            return "‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏≥‡πÄ‡∏•‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÉ‡∏Å‡∏•‡πâ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢"

        # 4. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô "‡∏´‡∏≤‡∏î‡∏ï‡∏≤‡πÅ‡∏´‡∏ß‡∏ô (1.4 ‡∏Å‡∏°.)"
        place_strings = [f"{p['name']} ({p['distance']})" for p in top_nearby]
        
        # ‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥‡∏Ñ‡∏±‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ "‡πÅ‡∏•‡∏∞" ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        if len(place_strings) > 1:
            places_combined = ", ".join(place_strings[:-1]) + " ‡πÅ‡∏•‡∏∞ " + place_strings[-1]
        else:
            places_combined = place_strings[0]

        # 5. ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏Å‡∏£‡∏¥‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
        res = f"{random.choice(loc_verbs)} {places_combined}"

        return res.strip()

    except Exception as e:
        return "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡∏µ ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÉ‡∏Å‡∏•‡πâ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢"

# --- 4. Core Engine 2: AI Summary (GPT-4o-mini) ---
def generate_ai_summary(row):
    raw_desc = row.get('description', '')[:1500] 
    title = row.get('title') or row.get('name') or 'Pool Villa'
    
    system_prompt = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Real Estate Scout ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å Style: ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö, ‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤, ‡πÄ‡∏ô‡πâ‡∏ô Object ‡πÅ‡∏•‡∏∞ Distance ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î"
    
    user_prompt = f"""
    ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ (‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ):
    Data:
    Title: {title}
    Description: {raw_desc}

    üö´ **‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ:**
    1. ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÅ‡∏£‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ß‡∏¥‡∏•‡∏•‡πà‡∏≤", "‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å", "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å", "‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó", "‡∏ö‡πâ‡∏≤‡∏ô", "‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å"
    2. ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å
    ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô" (‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥, ‡πÇ‡∏ï‡πä‡∏∞‡∏û‡∏π‡∏•, ‡∏Ñ‡∏£‡∏±‡∏ß, ‡∏ß‡∏¥‡∏ß)
    üí° Location: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "system", "content": system_prompt}, {"role": "user", "content": user_prompt}],
            temperature=0.3,
            max_tokens=250
        )
        return response.choices[0].message.content.strip()
    except:
        return None

# --- 5. Main Execution ---
if __name__ == "__main__":
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ DataFrame ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    # df = pd.read_sql("SELECT * FROM villas", engine) 
    
    # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô
    # df['short_description'] = df.apply(generate_short_desc, axis=1)
    # df['ai_summary'] = df.apply(generate_ai_summary, axis=1)
    
    print("üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå!")